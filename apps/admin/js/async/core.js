async = (function($){	var self = {};	self.REGEX = new RegExp('^https?://'+ document.domain +'(/.*)', 'i');	self.options = {};	self.options.container = '#content'; // CSS selector for where to put the returned HTML data	self.options.debug = false;	self.options.compile = true; // auto include scripts into HTML?	self._loading = false; // current URI being loaded	self.set_options = function(options){		$.extend(self.options,options);	};	self.bind = function(){		$('#admin-bar a').on('click',function(e){e.stopImmediatePropagation();});		$('#preview-bar a').on('click',function(e){e.stopImmediatePropagation();});		$('a'+		':not(.admin-tools-hide-preview)'+		':not([class^="editable"])'+		':not([href^="/blog/edit"])'+		':not([href^="/blog/add"])'+		':not([href^="/events/add"])'+		':not([href^="/user/logout"])'+		':not(.admin-tools a)').on('click', function(e){			e.preventDefault();			e.stopImmediatePropagation();			return async.link(this.href, false);		});	};	self.link = function(target, pop_state){		if (!self.REGEX.test(target) && !pop_state) {			if (self.options.debug) console.log('Caught external link.');			window.open(target,'_blank');			return false;		}		if (self.options.debug) console.log('Caught internal link.');		var uri, $container = $($(self.options.container)[0]), $document = $(document);		if (pop_state) { uri = target; }		else { uri = self.REGEX.exec(target)[1]; }		if (self.options.debug) console.log('URI: '+ uri);		if (uri != $container.attr('data-path')){			self._loading = uri.split('?')[0];			$document.trigger('async_start');			$.getJSON('/admin/api/async?page='+ encodeURIComponent(uri)).success(function(res){				if (self.options.debug) console.log(res);				if (res.success) {					if (self._loading !== res.data.path) return false;					$document.trigger({type:'async_pre', data:res.data});					$container.html(res.data.html + (self.options.compile?res.data.page.scripts.join(''):''));					$document.trigger({type:'async_post', data:res.data});					if (self.options.debug) console.log('Async load successful');					document.cookie = 'elefant_last_page='+ res.data.path;					self.bind();					$container.attr('data-path',uri);					if (!pop_state) {						history.pushState({data:uri}, res.data.page.title, uri);					}					$('head title').text(res.data.page.title);					$document.trigger('async_success');					self._loading = false;				} else {					if (self.options.debug) console.log(res);					$document.trigger({type:'async_error', data:res});				}			}).fail(function(){				if (self.options.debug) console.log('Async load unsuccessful');				$document.trigger('async_fail');			}).always(function(){				$document.trigger('async_end');			});		}		return false;	};	console.log('Async wrapper loaded.');	return self;}(jQuery));window.onpopstate = function(e){	if (e.state) async.link(e.state.data, true);};$(document).ready(async.bind);